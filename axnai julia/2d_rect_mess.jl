using Plots
using LinearAlgebra
using Polynomials

using SparseArrays
using Arpack

using ForwardDiff

using BenchmarkTools

#define integration functions
function Lagrange(x,xi,xj)
           p = poly(xj[:])
           p = p/p(xi)
           y = p(x)
           return y
end

function H(x,xi,xj)
    Lval(y) = Lagrange(y,xi,xj)
    Ldot = ForwardDiff.derivative(Lval,xi)
    H = (1-2*(x-xi)*Ldot)*Lagrange(x,xi,xj)^2
    return H
end
function Hbar(x,xi,xj)
    Hbar = (x-xi)*Lagrange(x,xi,xj)^2
    return Hbar
end
#produces (w,p)
function gauss(n)
    w = zeros(n,1)
    global coeffs = zeros(n+1,1);
    for k = Int64.(0:floor(n/2))
        coeffs[2*k+1] = (-1)^k*binomial(n,k)*binomial(2*n-2*k,n)/(2^n);
    end
    coeffs = Poly(reverse(coeffs,dims=1)[:])
    points = roots(coeffs);

    for i=1:n
        L = poly(points[[1:i-1; i+1:end]]);
        L = L/polyval(L,points[i]);
        L = polyint(L);
        w[i] = polyval(L,1)-polyval(L,-1);

    end
    #I = sum(w(i).*f(points));
    return w,points
end
gaussw,gausspoints = gauss(6) #used to integrate by gaussintegral
#results I
function gaussintegral(x1,x2,w,points,f)
    g(y) = 0.5*(x2-x1)*f.((x2-x1)*y/2 +(x2+x1)/2)
    I = sum(w.*g.(points))
    return I
end
function quad(ksi,eta,xs,ys,n)
    #x and y must be line vectors!!!!
    #returns x,y on selected ksi, eta points
    xs = reshape(xs,(n,n))'
    ys = reshape(ys,(n,n))'
    nξ = n; nη = n;
    ξ = LinRange(-1,1,nξ); η = LinRange(-1,1,nη)
    Nij(i,j,ξi,ηi) = Lagrange(ξi,ξ[i],ξ[deleteat!(collect(1:nξ),i)])*Lagrange(ηi,η[j],η[deleteat!(collect(1:nη),j)])
    x = 0
    y = 0
    for i=1:n
        for j=1:n
            x = x + xs[i,j]*Nij(i,j,ksi,eta)
            y = y + ys[i,j]*Nij(i,j,ksi,eta)
        end
    end
    return x,y
end
#nodesξη =reverse(collect(Iterators.product(ξ, η)),dims=1)
#=
ξη
(-1.0, -1.0)       (-1.0, -0.333333)       (-1.0, 0.333333)       (-1.0, 1.0)
(-0.333333, -1.0)  (-0.333333, -0.333333)  (-0.333333, 0.333333)  (-0.333333, 1.0)
(0.333333, -1.0)   (0.333333, -0.333333)   (0.333333, 0.333333)   (0.333333, 1.0)
(1.0, -1.0)        (1.0, -0.333333)        (1.0, 0.333333)        (1.0, 1.0)
=#
#=
ij
-------------------------------
|(1, 1)  (1, 2)  (1, 3)  (1, 4)|
|(2, 1)  (2, 2)  (2, 3)  (2, 4)|
|(3, 1)  (3, 2)  (3, 3)  (3, 4)|
|(4, 1)  (4, 2)  (4, 3)  (4, 4)|
-------------------------------
=#

gridksi = -1:0.1:1
grideta = -1:0.1:1
#=
x = [0 .5 1 0.2 0.7 1.2 0 .5 1]
y = [0 .2 0 .5 .7 .5 1 1.2 1]
=#
#=
x = [0 .5 1   0.2 0.7 1  .5 .5 .5 ]
y = [0 .2 0   .5 .7 .5   1.2 1.2 1.2]
for i=gridksi
for j=grideta
@show scatter!(quad(i,j,x,y,3))
end
end
scatter!(0,0,xlim=(-1,2),ylim=(-1,2))
=#



a =
[
1 1.50000000000000e+000 0.00000000000000e+000 0.00000000000000e+000
2 1.50000000000000e+000 -5.00000000000000e-001 0.00000000000000e+000
3 -5.00000000000000e-001 -5.00000000000000e-001 0.00000000000000e+000
4 -5.00000000000000e-001 5.00000000000000e-001 0.00000000000000e+000
5 7.00000000000000e-001 0.00000000000000e+000 0.00000000000000e+000
6 5.00000000000000e-001 5.00000000000000e-001 0.00000000000000e+000
7 5.00000000000000e-001 2.00000000000000e-001 0.00000000000000e+000
8 5.00000000000000e-001 3.25122607161425e-001 0.00000000000000e+000
9 5.25757751348917e-001 1.01818337837384e-001 0.00000000000000e+000
10 6.00905496286661e-001 2.62752771370548e-002 0.00000000000000e+000
11 -3.48319627796584e-002 5.00000000000000e-001 0.00000000000000e+000
12 2.83100570944130e-001 5.00000000000000e-001 0.00000000000000e+000
13 -5.00000000000000e-001 1.04886057799731e-002 0.00000000000000e+000
14 6.99181607086956e-002 -5.00000000000000e-001 0.00000000000000e+000
15 4.08910446367591e-001 -5.00000000000000e-001 0.00000000000000e+000
16 6.68456942063483e-001 -5.00000000000000e-001 0.00000000000000e+000
17 1.03291595963311e+000 -5.00000000000000e-001 0.00000000000000e+000
18 8.57706719337010e-001 0.00000000000000e+000 0.00000000000000e+000
19 1.10090800870009e+000 0.00000000000000e+000 0.00000000000000e+000
20 4.10331721534338e-001 2.40980976738870e-001 0.00000000000000e+000
21 3.49368545508411e-001 3.45230370803862e-001 0.00000000000000e+000
22 4.20104910130627e-001 1.14971124398750e-001 0.00000000000000e+000
23 4.84874006719494e-001 8.39055900973816e-004 0.00000000000000e+000
24 5.90793460297800e-001 -9.86579890558340e-002 0.00000000000000e+000
25 2.50797232066804e-001 -2.32278307859440e-001 0.00000000000000e+000
26 7.89637259664413e-001 -2.13211900945929e-001 0.00000000000000e+000
27 -1.16952216404802e-001 -1.63675079090689e-001 0.00000000000000e+000
28 -1.43335173632234e-001 1.94649175997281e-001 0.00000000000000e+000
29 1.35991639556277e-001 3.00509774167189e-001 0.00000000000000e+000
30 5.27887884548518e-001 -2.96297125882453e-001 0.00000000000000e+000
31 4.31619450374712e-001 -1.33658805246273e-001 0.00000000000000e+000
32 3.21403362066623e-001 2.20900710270586e-003 0.00000000000000e+000
33 2.77296587707128e-001 1.78124248075801e-001 0.00000000000000e+000
34 1.04838596131384e-001 4.79931869172710e-002 0.00000000000000e+000
35 5.00000000000000e-001 2.62561303580713e-001 0.00000000000000e+000
36 5.00000000000000e-001 4.12561303580713e-001 0.00000000000000e+000
37 5.06546582182924e-001 1.49247905118196e-001 0.00000000000000e+000
38 5.58208132979089e-001 5.89501278032330e-002 0.00000000000000e+000
39 6.48740584145881e-001 6.68038825226625e-003 0.00000000000000e+000
40 -2.67415981389829e-001 5.00000000000000e-001 0.00000000000000e+000
41 1.24134304082236e-001 5.00000000000000e-001 0.00000000000000e+000
42 3.91550285472065e-001 5.00000000000000e-001 0.00000000000000e+000
43 -5.00000000000000e-001 -2.44755697110013e-001 0.00000000000000e+000
44 -5.00000000000000e-001 2.55244302889987e-001 0.00000000000000e+000
45 -2.15040919645652e-001 -5.00000000000000e-001 0.00000000000000e+000
46 2.39414303538144e-001 -5.00000000000000e-001 0.00000000000000e+000
47 5.38683694215537e-001 -5.00000000000000e-001 0.00000000000000e+000
48 8.50686450848297e-001 -5.00000000000000e-001 0.00000000000000e+000
49 1.26645797981656e+000 -5.00000000000000e-001 0.00000000000000e+000
50 1.50000000000000e+000 -2.50000000000000e-001 0.00000000000000e+000
51 7.78853359668505e-001 0.00000000000000e+000 0.00000000000000e+000
52 9.79307364018549e-001 0.00000000000000e+000 0.00000000000000e+000
53 1.30045400435004e+000 0.00000000000000e+000 0.00000000000000e+000
54 4.55165860767169e-001 2.83051791950148e-001 0.00000000000000e+000
55 4.55165860767169e-001 2.20490488369435e-001 0.00000000000000e+000
56 4.24684272754205e-001 4.22615185401931e-001 0.00000000000000e+000
57 4.24684272754205e-001 3.35176488982644e-001 0.00000000000000e+000
58 3.79850133521374e-001 2.93105673771366e-001 0.00000000000000e+000
59 3.16234558226270e-001 4.22615185401931e-001 0.00000000000000e+000
60 4.57894118638775e-001 1.59513584815777e-001 0.00000000000000e+000
61 4.72931330739772e-001 1.08394731118067e-001 0.00000000000000e+000
62 5.05315879034205e-001 5.13286968691788e-002 0.00000000000000e+000
63 5.43606599873384e-001 1.02871452596292e-002 0.00000000000000e+000
64 5.95849478292230e-001 -3.61913559593896e-002 0.00000000000000e+000
65 6.47563847040500e-001 -5.17278204023008e-002 0.00000000000000e+000
66 3.29853839217198e-001 -3.66139153929720e-001 0.00000000000000e+000
67 1.60357696387750e-001 -3.66139153929720e-001 0.00000000000000e+000
68 1.30045400435004e+000 -2.50000000000000e-001 0.00000000000000e+000
69 1.06691198416660e+000 -2.50000000000000e-001 0.00000000000000e+000
70 7.44818629832207e-001 -1.06605950472964e-001 0.00000000000000e+000
71 8.23671989500712e-001 -1.06605950472964e-001 0.00000000000000e+000
72 4.52489458425060e-001 5.79050901498618e-002 0.00000000000000e+000
73 5.34350887812583e-001 -5.26171255655412e-002 0.00000000000000e+000
74 6.69225078310011e-002 -1.97976693475064e-001 0.00000000000000e+000
75 -2.35170278480530e-002 -3.31837539545345e-001 0.00000000000000e+000
76 -3.21667586816117e-001 3.47324587998640e-001 0.00000000000000e+000
77 -8.90835682059463e-002 3.47324587998640e-001 0.00000000000000e+000
78 5.05798383883092e-002 4.00254887083594e-001 0.00000000000000e+000
79 2.09546105250203e-001 4.00254887083594e-001 0.00000000000000e+000
80 -3.08476108202401e-001 -3.31837539545345e-001 0.00000000000000e+000
81 -3.08476108202401e-001 -7.65932366553579e-002 0.00000000000000e+000
82 -3.21667586816117e-001 1.02568890888627e-001 0.00000000000000e+000
83 5.97285422738515e-001 -3.98760647717331e-001 0.00000000000000e+000
84 4.68399165458055e-001 -3.98148562941227e-001 0.00000000000000e+000
85 9.11276609648762e-001 -3.56605950472965e-001 0.00000000000000e+000
86 7.29047100863948e-001 -3.56605950472965e-001 0.00000000000000e+000
87 3.89342558307661e-001 -2.64287716870947e-001 0.00000000000000e+000
88 -3.67176703797865e-003 2.47579475082235e-001 0.00000000000000e+000
89 9.45272634182251e-001 -1.06605950472964e-001 0.00000000000000e+000
90 4.10629798807141e-001 1.77620170124280e-001 0.00000000000000e+000
91 6.59602355112067e-001 -2.57400142370688e-001 0.00000000000000e+000
92 -1.30143695018518e-001 1.54870484532958e-002 0.00000000000000e+000
93 6.88028927014763e-001 -1.59730176703708e-001 0.00000000000000e+000
94 2.42680092532344e-001 3.22870072485525e-001 0.00000000000000e+000
95 4.58246728547103e-001 -6.64098746726493e-002 0.00000000000000e+000
96 5.11640909426539e-001 -1.18134173924417e-001 0.00000000000000e+000
97 5.59340672423159e-001 -1.97477557469144e-001 0.00000000000000e+000
98 -6.05681013670853e-003 -5.78409460867090e-002 0.00000000000000e+000
99 -1.92482887504249e-002 1.21321181457276e-001 0.00000000000000e+000
100 3.70754136098625e-001 5.85900657507278e-002 0.00000000000000e+000
101 4.03138684393058e-001 1.52403150183984e-003 0.00000000000000e+000
102 3.13332566607769e-001 2.61677309439832e-001 0.00000000000000e+000
103 3.43814154620733e-001 2.09552612407336e-001 0.00000000000000e+000
104 3.47859861277036e-001 1.44646184831072e-001 0.00000000000000e+000
105 2.06644113631702e-001 2.39317011121495e-001 0.00000000000000e+000
106 4.78186597606172e-001 -2.15905541308102e-001 0.00000000000000e+000
107 2.97439628208300e-001 8.96876512968401e-002 0.00000000000000e+000
108 3.41208341220758e-001 -1.82968556552856e-001 0.00000000000000e+000
109 1.91067591919256e-001 1.13058717496536e-001 0.00000000000000e+000
110 2.13120979099004e-001 2.51010970099884e-002 0.00000000000000e+000
111 1.77817914099094e-001 -9.21425604710844e-002 0.00000000000000e+000
112 3.76511406220667e-001 -6.57248990717833e-002 0.00000000000000e+000
113 1.20415117843831e-001 1.74251480542230e-001 0.00000000000000e+000
114 2.86100297066713e-001 -1.15034650378367e-001 0.00000000000000e+000
]
a = a[:,2:3]
x = a[:,1]; y = a[:,2];
elem  = [
20 206 7 8 20 35 54 55
21 206 8 6 21 36 56 57
22 206 20 8 21 54 57 58
23 206 6 12 21 42 59 56
24 206 9 7 22 37 60 61
25 206 10 9 23 38 62 63
26 206 5 10 24 39 64 65
27 206 14 15 25 46 66 67
28 206 17 2 19 49 68 69
29 206 2 1 19 50 53 68
30 206 18 5 26 51 70 71
31 206 23 9 22 62 61 72
32 206 10 23 24 63 73 64
33 206 14 25 27 67 74 75
34 206 11 4 28 40 76 77
35 206 12 11 29 41 78 79
36 206 13 3 27 43 80 81
37 206 4 13 28 44 82 76
38 206 3 14 27 45 75 80
39 206 15 16 30 47 83 84
40 206 16 17 26 48 85 86
41 206 15 30 25 84 87 66
42 206 29 11 28 78 77 88
43 206 18 26 19 71 89 52
44 206 7 20 22 55 90 60
45 206 30 16 26 83 86 91
46 206 13 27 28 81 92 82
47 206 5 24 26 65 93 70
48 206 12 29 21 79 94 59
49 206 24 23 31 73 95 96
50 206 26 24 30 93 97 91
51 206 27 34 28 98 99 92
52 206 23 22 32 72 100 101
53 206 20 21 33 58 102 103
54 206 22 20 33 90 103 104
55 206 21 29 33 94 105 102
56 206 17 19 26 69 89 85
57 206 30 24 31 97 96 106
58 206 32 22 33 100 104 107
59 206 30 31 25 106 108 87
60 206 32 33 34 107 109 110
61 206 27 25 34 74 111 98
62 206 31 23 32 95 101 112
63 206 34 33 29 109 105 113
64 206 32 34 25 110 111 114
65 206 29 28 34 88 99 113
66 206 32 25 31 114 108 112
]
elem = elem[:,3:end]
for nele=1:size(elem)[1]
    xs = zeros(1,6)
    xs = x[elem[nele],:]
    ys = zeros(1,6)
    ys = y[elem[nele],:]
